<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مولد تصویر آلفا</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* CSS کاملاً بدون تغییر باقی مانده است */
    :root {
        --igadlm-alpha-color-primary: #5A67D8;
        --igadlm-alpha-color-primary-darker: #4C51BF;
        --igadlm-alpha-color-secondary: #805AD5;
        --igadlm-alpha-color-secondary-darker: #6B46C1;
        --igadlm-alpha-color-accent: #DD6B20;
        --igadlm-alpha-color-text: #1A202C;
        --igadlm-alpha-color-text-light: #4A5568;
        --igadlm-alpha-color-text-muted: #718096;
        --igadlm-alpha-color-bg-card: #FFFFFF;
        --igadlm-alpha-color-border: #CBD5E0;
        --igadlm-alpha-color-input-bg: #EDF2F7;
        --igadlm-alpha-color-white: #FFFFFF;
        --igadlm-alpha-color-success: #38A169;
        --igadlm-alpha-color-error: #E53E3E;
        --igadlm-alpha-color-warning-bg: #FFFBEB;
        --igadlm-alpha-color-warning-border: #FBBF24;
        --igadlm-alpha-color-warning-text: #B45309;
        --igadlm-alpha-shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px 0 rgba(0, 0, 0, 0.04);
        --igadlm-alpha-shadow-md: 0 4px 8px -2px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        --igadlm-alpha-shadow-lg: 0 10px 20px -5px rgba(0, 0, 0, 0.1), 0 6px 10px -5px rgba(0, 0, 0, 0.05);
        --igadlm-alpha-shadow-focus: 0 0 0 3px rgba(90, 103, 216, 0.35);
        --igadlm-alpha-border-radius-md: 8px;
        --igadlm-alpha-border-radius-lg: 12px;
        --igadlm-alpha-transition-speed: 0.25s;
        --igadlm-alpha-transition-easing: cubic-bezier(0.4, 0, 0.2, 1);
    }
    html, body { background-color: #f0f2f5; margin:0; padding:0; display: flex; flex-direction: column; align-items: center; font-family: 'Vazirmatn', 'Tahoma', sans-serif;}
    #imageGeneratorAppAlphaV2 *, #imageGeneratorAppAlphaV2 *::before, #imageGeneratorAppAlphaV2 *::after { box-sizing: border-box; margin: 0; padding: 0; border-width: 0; border-style: solid; }
    #imageGeneratorAppAlphaV2 { all: unset; display: block; color: var(--igadlm-alpha-color-text); line-height: 1.6; direction: rtl; padding: 20px 0; width: 100%; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow-x: hidden; background-color: transparent; }
    #imageGeneratorAppAlphaV2 div, #imageGeneratorAppAlphaV2 p, #imageGeneratorAppAlphaV2 h1, #imageGeneratorAppAlphaV2 h2, #imageGeneratorAppAlphaV2 h3, #imageGeneratorAppAlphaV2 label, #imageGeneratorAppAlphaV2 input, #imageGeneratorAppAlphaV2 textarea, #imageGeneratorAppAlphaV2 button, #imageGeneratorAppAlphaV2 img, #imageGeneratorAppAlphaV2 ul, #imageGeneratorAppAlphaV2 li, #imageGeneratorAppAlphaV2 span, #imageGeneratorAppAlphaV2 strong { all: revert; box-sizing: border-box; font-family: inherit; }
    #imageGeneratorAppAlphaV2 .app-content-wrapper { display: flex; justify-content: center; width: 100%; overflow-x: hidden; }
    #imageGeneratorAppAlphaV2 .app-content { width: 100%; max-width: 550px; padding: 0 15px; }
    #imageGeneratorAppAlphaV2 .app-header { text-align: center; margin-bottom: 30px; }
    #imageGeneratorAppAlphaV2 .app-header h1 { font-size: clamp(1.8em, 5.5vw, 2.3em); font-weight: 700; color: var(--igadlm-alpha-color-primary); margin-bottom: 8px; }
    #imageGeneratorAppAlphaV2 .app-header p { font-size: 0.95em; color: var(--igadlm-alpha-color-text-light); }
    #imageGeneratorAppAlphaV2 .form-section-card { background-color: var(--igadlm-alpha-color-bg-card); padding: 30px; border-radius: var(--igadlm-alpha-border-radius-lg); box-shadow: var(--igadlm-alpha-shadow-lg); border: 1px solid var(--igadlm-alpha-color-border); transition: opacity 0.3s ease-in-out, height 0.3s ease-in-out, padding 0.3s ease-in-out, margin 0.3s ease-in-out, border 0.3s ease-in-out; }
    #imageGeneratorAppAlphaV2 .form-section-card.hidden-form { opacity: 0; pointer-events: none; height: 0; overflow: hidden; padding: 0; margin:0; border: none; }
    #imageGeneratorAppAlphaV2 .form-group { margin-bottom: 20px; }
    #imageGeneratorAppAlphaV2 .form-group label { display: block; font-size: 0.85rem; color: var(--igadlm-alpha-color-text-light); margin-bottom: 6px; font-weight: 600; }
    #imageGeneratorAppAlphaV2 #imagePromptAlpha { width: 100%; padding: 10px 14px; border: 1px solid var(--igadlm-alpha-color-border); border-radius: var(--igadlm-alpha-border-radius-md); font-size: 0.9rem; background-color: var(--igadlm-alpha-color-input-bg); color: var(--igadlm-alpha-color-text); font-family: inherit; transition: border-color var(--igadlm-alpha-transition-speed) var(--igadlm-alpha-transition-easing), box-shadow var(--igadlm-alpha-transition-speed) var(--igadlm-alpha-transition-easing), background-color var(--igadlm-alpha-transition-speed) var(--igadlm-alpha-transition-easing); min-height: 60px; resize: vertical; -webkit-backface-visibility: hidden; backface-visibility: hidden; transform: translateZ(0); }
    #imageGeneratorAppAlphaV2 #imagePromptAlpha::placeholder { color: var(--igadlm-alpha-color-text-muted); opacity: 0.7; }
    #imageGeneratorAppAlphaV2 #imagePromptAlpha:focus { outline: none; border-color: var(--igadlm-alpha-color-primary); box-shadow: var(--igadlm-alpha-shadow-focus); background-color: var(--igadlm-alpha-color-white); }
    #imageGeneratorAppAlphaV2 .dimension-buttons-simple { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    #imageGeneratorAppAlphaV2 .dimension-button-simple { padding: 10px 8px; font-size: 0.9rem; font-weight: 500; line-height: 1.3; border: 1px solid var(--igadlm-alpha-color-border); border-radius: var(--igadlm-alpha-border-radius-md); background-color: var(--igadlm-alpha-color-input-bg); color: var(--igadlm-alpha-color-text-muted); cursor: pointer; text-align: center; font-family: inherit; transition: all var(--igadlm-alpha-transition-speed) var(--igadlm-alpha-transition-easing); position: relative; box-shadow: var(--igadlm-alpha-shadow-sm); }
    #imageGeneratorAppAlphaV2 .dimension-button-simple.selected { background: linear-gradient(60deg, var(--igadlm-alpha-color-primary) 0%, var(--igadlm-alpha-color-secondary) 100%); color: var(--igadlm-alpha-color-white); border-color: transparent; font-weight: 600; transform: translateY(-2px); box-shadow: var(--igadlm-alpha-shadow-md); }
    #imageGeneratorAppAlphaV2 .dimension-button-simple.selected::after { content: ''; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 12px; height: 3px; background-color: rgba(255, 255, 255, 0.7); border-radius: 2px; }
    #imageGeneratorAppAlphaV2 .dimension-button-simple:hover:not(.selected) { border-color: var(--igadlm-alpha-color-primary-darker); color: var(--igadlm-alpha-color-primary-darker); background-color: var(--igadlm-alpha-color-white); transform: translateY(-1px); box-shadow: var(--igadlm-alpha-shadow-md); }
    @media (min-width: 400px) { #imageGeneratorAppAlphaV2 .dimension-buttons-simple { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); }}
    #imageGeneratorAppAlphaV2 #generateBtnAlpha { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 11px 16px; border-radius: var(--igadlm-alpha-border-radius-md); font-size: 0.95rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all var(--igadlm-alpha-transition-speed) var(--igadlm-alpha-transition-easing); box-shadow: var(--igadlm-alpha-shadow-md); background: linear-gradient(60deg, var(--igadlm-alpha-color-primary) 0%, var(--igadlm-alpha-color-secondary) 100%); color: var(--igadlm-alpha-color-white); border-style: none; margin-top: 12px; }
    #imageGeneratorAppAlphaV2 #generateBtnAlpha:hover:not(:disabled) { background: linear-gradient(60deg, var(--igadlm-alpha-color-primary-darker) 0%, var(--igadlm-alpha-color-secondary-darker) 100%); transform: translateY(-2px); box-shadow: var(--igadlm-alpha-shadow-lg); }
    #imageGeneratorAppAlphaV2 #generateBtnAlpha:disabled { background: #cbd5e0 !important; color: #718096 !important; cursor: not-allowed; box-shadow: none !important; transform: none !important; }
    #imageGeneratorAppAlphaV2 #aiLoaderAlpha { display: none; flex-direction: column; align-items: center; margin: 20px auto 10px auto; }
    #imageGeneratorAppAlphaV2 .ai-loader-bar-container-inline { display: flex; justify-content: center; align-items: flex-end; height: 25px; }
    #imageGeneratorAppAlphaV2 .ai-loader-bar-inline { width: 5px; height: 5px; background-color: var(--igadlm-alpha-color-primary); border-radius: 2.5px; margin: 0 2.5px; animation: igadlmAlphaV2LoaderAnim 1.2s infinite ease-in-out; }
    #imageGeneratorAppAlphaV2 .ai-loader-bar-inline:nth-child(2) { animation-delay: 0.2s; background-color: var(--igadlm-alpha-color-secondary); }
    #imageGeneratorAppAlphaV2 .ai-loader-bar-inline:nth-child(3) { animation-delay: 0.4s; }
    #imageGeneratorAppAlphaV2 #statusAlphaText { text-align: center; font-size: 0.85em; color: var(--igadlm-alpha-color-text-muted); font-weight: 500; margin-top: 10px; min-height: 1.4em; }
    #imageGeneratorAppAlphaV2 #imageResultContainerAlpha { margin-top: 15px; text-align: center; display: none; }
    #imageGeneratorAppAlphaV2 #generatedImageAlpha { max-width: 100%; height: auto; min-height: 180px; border-radius: var(--igadlm-alpha-border-radius-md); box-shadow: var(--igadlm-alpha-shadow-md); display: none; border: 1px solid var(--igadlm-alpha-color-border); background-color: var(--igadlm-alpha-color-input-bg); object-fit: contain; margin: 0 auto; }
    #imageGeneratorAppAlphaV2 #downloadLinkStatusAlpha { font-size: 0.85em; color: var(--igadlm-alpha-color-text-light); margin-top: 10px; min-height: 1.4em; font-weight: 500; text-align: center; }
    #imageGeneratorAppAlphaV2 #downloadImageBtnAlpha { display: none; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 11px 16px; border-radius: var(--igadlm-alpha-border-radius-md); font-size: 0.95rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all var(--igadlm-alpha-transition-speed) var(--igadlm-alpha-transition-easing); margin-top: 10px; background-color: var(--igadlm-alpha-color-white); color: var(--igadlm-alpha-color-primary); border: 1px solid var(--igadlm-alpha-color-border); box-shadow: var(--igadlm-alpha-shadow-sm); }
    #imageGeneratorAppAlphaV2 #downloadImageBtnAlpha:hover:not(:disabled) { background: linear-gradient(60deg, var(--igadlm-alpha-color-primary) 0%, var(--igadlm-alpha-color-secondary) 100%); color: var(--igadlm-alpha-color-white); border-color: transparent; transform: translateY(-2px); box-shadow: var(--igadlm-alpha-shadow-lg); }
    #imageGeneratorAppAlphaV2 #downloadImageBtnAlpha:disabled { background-color: var(--igadlm-alpha-color-input-bg) !important; color: var(--igadlm-alpha-color-text-muted) !important; border-color: var(--igadlm-alpha-color-border) !important; box-shadow: none !important; transform: none !important; cursor: not-allowed; }
    #imageGeneratorAppAlphaV2 .status-output-area { margin-top: 25px; min-height: 0; }
    #imageGeneratorAppAlphaV2 .gpu-error-message-container { background-color: var(--igadlm-alpha-color-warning-bg); padding: 25px; border-radius: var(--igadlm-alpha-border-radius-lg); box-shadow: var(--igadlm-alpha-shadow-lg); border: 2px solid var(--igadlm-alpha-color-warning-border); animation: igadlmAlphaV2fadeInUp 0.5s var(--igadlm-alpha-transition-easing) both; }
    #imageGeneratorAppAlphaV2 .gpu-error-message-container h2 { font-size: 1.2em; color: var(--igadlm-alpha-color-warning-text); margin-bottom: 15px; font-weight: 700; display: flex; align-items: center; border-bottom: 1px solid var(--igadlm-alpha-color-warning-border); padding-bottom: 12px; }
    #imageGeneratorAppAlphaV2 .gpu-error-message-container h2 .icon { margin-left: 10px; font-size: 1.3em; }
    #imageGeneratorAppAlphaV2 .gpu-error-message-container .error-content { font-size: 0.9rem; color: var(--igadlm-alpha-color-text-light); line-height: 1.7; word-break: break-word; white-space: pre-line; }
    #imageGeneratorAppAlphaV2 .gpu-error-message-container .error-content strong.error-message-title { font-weight: 600; color: var(--igadlm-alpha-color-warning-text); display: block; margin-bottom: 8px;}
    #imageGeneratorAppAlphaV2 .gpu-error-message-container .error-content ul { list-style-type: "▫️ "; padding-right: 20px; margin-top: 10px; }
    #imageGeneratorAppAlphaV2 .gpu-error-message-container .error-content li { margin-bottom: 6px; }
    #imageGeneratorAppAlphaV2 .gpu-error-actions { display: flex; gap: 15px; margin-top: 25px; }
    #imageGeneratorAppAlphaV2 .gpu-error-actions .action-button { padding: 12px 20px; border: none; border-radius: var(--igadlm-alpha-border-radius-md); font-size: 0.95em; font-weight: 600; cursor: pointer; font-family: inherit; width: 100%; box-shadow: var(--igadlm-alpha-shadow-md); transition: all var(--igadlm-alpha-transition-speed) var(--igadlm-alpha-transition-easing); text-transform: none; letter-spacing: normal; }
    #imageGeneratorAppAlphaV2 .gpu-error-actions .action-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--igadlm-alpha-shadow-lg); }
    #imageGeneratorAppAlphaV2 .gpu-error-actions .action-button.back-button { background-color: var(--igadlm-alpha-color-bg-card); color: var(--igadlm-alpha-color-text-muted); border: 1px solid var(--igadlm-alpha-color-border); flex-grow: 0.45; }
    #imageGeneratorAppAlphaV2 .gpu-error-actions .action-button.back-button:hover:not(:disabled) { background-color: var(--igadlm-alpha-color-input-bg); }
    #imageGeneratorAppAlphaV2 .gpu-error-actions .action-button.retry-button { background: linear-gradient(60deg, var(--igadlm-alpha-color-primary) 0%, var(--igadlm-alpha-color-secondary) 100%); color: white; flex-grow: 1; }
    #imageGeneratorAppAlphaV2 .gpu-error-actions .action-button.retry-button:hover:not(:disabled) { background: linear-gradient(60deg, var(--igadlm-alpha-color-primary-darker) 0%, var(--igadlm-alpha-color-secondary-darker) 100%); }
    @keyframes igadlmAlphaV2LoaderAnim { 0%, 100% { transform: scaleY(0.5); opacity: 0.5; } 50% { transform: scaleY(1.5); opacity: 1; height: 15px; } }
    @keyframes igadlmAlphaV2fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>
<div id="imageGeneratorAppAlphaV2">
    <div class="app-content-wrapper">
        <div class="app-content">
            <div class="app-header">
                <h1>🖼️ مولد تصویر آلفا</h1>
                <p><span style="color: #339966;">Flux pro</span></p>
                <p>ایده خود را به یک تصویر خلاقانه تبدیل کنید</p>
            </div>
            <div class="form-section-card" id="alphaFormSectionCard">
                <div class="form-group"><label for="imagePromptAlpha">ایده خود را بنویسید (به فارسی):</label> <textarea id="imagePromptAlpha" rows="3" placeholder="مثال: یک قلعه باستانی بر فراز ابرها"></textarea></div>
                <div class="form-group"><label>اندازه تصویر (نسبت):</label>
                    <div class="dimension-buttons-simple" id="alphaDimensionButtons"></div>
                </div>
                <button id="generateBtnAlpha">🎨 ساخت تصویر</button>
                <div class="ai-loader-inline" id="aiLoaderAlpha">
                    <div class="ai-loader-bar-container-inline">
                        <div class="ai-loader-bar-inline"></div>
                        <div class="ai-loader-bar-inline"></div>
                        <div class="ai-loader-bar-inline"></div>
                    </div>
                </div>
                <div id="statusAlphaText">وضعیت: آماده برای تولید تصویر.</div>
                <div id="imageResultContainerAlpha">
                    <img id="generatedImageAlpha" alt="تصویر ایجاد شده" />
                    <p id="downloadLinkStatusAlpha"> </p>
                    <button id="downloadImageBtnAlpha">📥 دانلود تصویر</button>
                </div>
            </div>
            <div class="status-output-area" id="alphaStatusOutputArea"></div>
        </div>
    </div>
</div>

<script>
    (function() {
        // --- شروع تغییرات اصلی برای اتصال به پراکسی Render.com ---

        // آدرس پراکسی که روی همین سرور Render اجرا می‌شود
        const PROXY_ENDPOINT = '/proxy';
        
        // آدرس‌های اصلی هاگینگ فیس
        const HF_IMAGE_GENERATOR_BASE = "https://black-forest-labs-flux-1-dev.hf.space";
        const HF_TRANSLATOR_BASE = "https://hamed744-translate-tts-aloha.hf.space";

        // ساخت URL های پراکسی شده
        // ما آدرس کامل هاگینگ فیس را به عنوان پارامتر به پراکسی خودمان پاس می‌دهیم
        const IMAGE_GENERATOR_API_BASE_URL = `${PROXY_ENDPOINT}?target_url=${encodeURIComponent(HF_IMAGE_GENERATOR_BASE)}`;
        const TRANSLATOR_API_BASE_URL = `${PROXY_ENDPOINT}?target_url=${encodeURIComponent(HF_TRANSLATOR_BASE)}`;
        
        // --- پایان تغییرات اصلی ---
        
        const appContainer = document.getElementById('imageGeneratorAppAlphaV2');
        if (!appContainer) { console.error("App container not found!"); return; }

        const formSectionCard = appContainer.querySelector('#alphaFormSectionCard');
        const statusOutputArea = appContainer.querySelector('#alphaStatusOutputArea');
        const generateBtn = appContainer.querySelector('#generateBtnAlpha');
        const statusTextDiv = appContainer.querySelector('#statusAlphaText');
        const imageResultContainer = appContainer.querySelector('#imageResultContainerAlpha');
        const generatedImageElem = appContainer.querySelector('#generatedImageAlpha');
        const aiLoader = appContainer.querySelector('#aiLoaderAlpha');
        const downloadImageBtn = appContainer.querySelector('#downloadImageBtnAlpha');
        const downloadLinkStatusEl = appContainer.querySelector('#downloadLinkStatusAlpha');
        const imagePromptInput = appContainer.querySelector('#imagePromptAlpha');
        const dimensionButtonsContainer = appContainer.querySelector('#alphaDimensionButtons');

        const IMAGE_GENERATOR_FN_INDEX = 2;
        const IMAGE_GENERATOR_TRIGGER_ID = 5;
        const DEFAULT_RANDOMIZE_SEED = true;
        const DEFAULT_GUIDANCE_SCALE = 3.5;
        const DEFAULT_INFERENCE_STEPS = 28;
        const TRANSLATOR_FN_INDEX = 1;
        const TRANSLATOR_OTHER_PARAMS = ["انگلیسی (آمریکا) - جنی (زن)", 0, 0, 0];
        
        // حذف شد: دیگر به سرور آپلود جداگانه نیاز نداریم. دانلود مستقیم انجام می‌شود
        // const YOUR_IMAGE_UPLOAD_SERVER_URL = '...';

        const GPU_QUOTA_INSTRUCTIONS_HTML_VIDEO_STYLE = `<h2><span class="icon">💡</span> راهنمای رفع محدودیت ویدیو</h2><div class="error-content"><strong class="error-message-title">ارور محدودیت استفاده از GPU</strong><p>مدل‌های هوش مصنوعی برای اجرا به کارت‌های گرافیک بسیار قدرتمند نیاز دارند که این امر گاهی محدودیت‌هایی جی پی یو را در استفاده از آن‌ها ایجاد می‌کند. با این حال، خبر خوب این است که این محدودیت‌ها با استفاده از یک ترفند ساده قابل رفع هستند.</p><p><strong>برای رفع محدودیت هر بار اینگونه عمل کنید:</strong></p><ul><li>اگر از اینترنت سیم‌کارت استفاده می‌کنید، فیلترشکن خود را حتما خاموش کنید.</li><li>به مدت ۱۰ تا ۱۵ ثانیه، گوشی خود را در حالت هواپیما قرار دهید و سپس آن را غیرفعال کنید. این محدودیت با همین روش برداشته میشود</li><li>اگر از وای فای استفاده می‌کنید، مودم خود را یک بار خاموش و روشن کنید (بهتر است برای استفاده نامحدود از برنامه از اینترنت سیم کارت استفاده کنید).</li></ul><p>خلاصه: هربار این صفحه اومد اینگونه عمل کنید از اینترنت سیم کارت استفاده کنید، فیلتر شکن خاموش باشه، یک یا دوبار حالت هواپیما رو روشن و خاموش کنید. تلاش مجدداً بزنید این ارور بر طرف میشه، با این روش میشه بصورت نامحدود با این برنامه تصاویر ساخت☘️</p></div>`;
        const PREDEFINED_DIMENSIONS_MAP = { "1:1": { width: 1024, height: 1024, display: "۱:۱ (مربع)" }, "16:9": { width: 1344, height: 768, display: "۱۶:۹ (افقی)" }, "9:16": { width: 768, height: 1344, display: "۹:۱۶ (عمودی)" }, "4:3":  { width: 1152, height: 864, display: "۴:۳ (کلاسیک)" }, };
        let selectedAspectRatioKey = Object.keys(PREDEFINED_DIMENSIONS_MAP)[0];
        let currentEventSource = null;
        let lastAttemptedPayload = null;
        let finalGeneratedImageUrlFromSpace = null;

        async function retryableOperation(operation, maxRetries = 3, delayMs = 2500, onRetry) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    return await operation();
                } catch (error) {
                    if (error && error.type === "gpu_quota") { throw error; }
                    console.warn(`Operation failed on attempt ${attempt}. Error:`, error);
                    if (attempt < maxRetries) {
                        if (onRetry) { onRetry(attempt, maxRetries); }
                        await new Promise(resolve => setTimeout(resolve, delayMs));
                    } else {
                        console.error("All retry attempts failed.");
                        throw error;
                    }
                }
            }
        }

        function populateDimensionButtons() {
            dimensionButtonsContainer.innerHTML = '';
            Object.keys(PREDEFINED_DIMENSIONS_MAP).forEach((key) => {
                const dimInfo = PREDEFINED_DIMENSIONS_MAP[key];
                const button = document.createElement('button');
                button.className = 'dimension-button-simple';
                button.textContent = dimInfo.display;
                button.dataset.ratioKey = key;
                if (key === selectedAspectRatioKey) { button.classList.add('selected'); }
                button.addEventListener('click', () => {
                    dimensionButtonsContainer.querySelectorAll('.dimension-button-simple').forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected'); selectedAspectRatioKey = button.dataset.ratioKey;
                });
                dimensionButtonsContainer.appendChild(button);
            });
        }
        
        function generateSessionHash() { return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15); }

        function showMainForm() {
            formSectionCard.classList.remove('hidden-form');
            const existingGpuErrorMsg = statusOutputArea.querySelector('.gpu-error-message-container');
            if (existingGpuErrorMsg) existingGpuErrorMsg.remove();
            generatedImageElem.removeAttribute('src');
            generatedImageElem.style.display = 'none';
            imageResultContainer.style.display = 'none';
            downloadImageBtn.style.display = 'none';
            downloadLinkStatusEl.textContent = '\u00A0';
        }

        function updateStatus(messageOrError, type = "info", showLoader = false) {
            statusTextDiv.innerHTML = '';
            aiLoader.style.display = showLoader ? 'flex' : 'none';
            if (type === "success") {
                downloadImageBtn.style.display = 'inline-flex';
                downloadLinkStatusEl.textContent = 'برای دانلود، روی دکمه کلیک کنید.';
            } else {
                downloadImageBtn.style.display = 'none';
                downloadLinkStatusEl.textContent = '\u00A0';
            }
            formSectionCard.classList.remove('hidden-form');
            const existingGpuErrorMsg = statusOutputArea.querySelector('.gpu-error-message-container');
            if (existingGpuErrorMsg) { existingGpuErrorMsg.remove(); }
            let messageText = "";
            let isGpuError = false;
            if (typeof messageOrError === 'object' && messageOrError !== null && messageOrError.type === "gpu_quota") {
                isGpuError = true; messageText = messageOrError.message;
            } else if (typeof messageOrError === 'string') {
                messageText = messageOrError;
                if (type === "error" && (messageText.toLowerCase().includes("gpu") || messageText.toLowerCase().includes("cuda") || messageText.toLowerCase().includes("quota") || messageText.toLowerCase().includes("capacity"))) {
                    isGpuError = true;
                }
            } else { messageText = String(messageOrError || "پیام نامشخص"); }
            if (isGpuError) {
                formSectionCard.classList.add('hidden-form');
                aiLoader.style.display = 'none';
                statusTextDiv.innerHTML = '';
                imageResultContainer.style.display = 'none';
                downloadImageBtn.style.display = 'none';
                downloadLinkStatusEl.textContent = '\u00A0';
                const gpuErrorContainer = document.createElement('div');
                gpuErrorContainer.className = 'gpu-error-message-container';
                gpuErrorContainer.innerHTML = GPU_QUOTA_INSTRUCTIONS_HTML_VIDEO_STYLE;
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'gpu-error-actions';
                const btnRetry = document.createElement('button');
                btnRetry.className = 'action-button retry-button';
                btnRetry.textContent = 'تلاش مجدد';
                btnRetry.onclick = () => { showMainForm(); if (lastAttemptedPayload) { startFullProcess(true); } else { updateStatus("آماده برای تلاش مجددد.", "info", false); } };
                const btnBack = document.createElement('button');
                btnBack.className = 'action-button back-button';
                btnBack.textContent = 'بازگشت به فرم';
                btnBack.onclick = () => { showMainForm(); updateStatus("وضعیت: آماده برای تولید تصویر.", "info", false); };
                actionsDiv.appendChild(btnBack); actionsDiv.appendChild(btnRetry);
                gpuErrorContainer.appendChild(actionsDiv);
                statusOutputArea.innerHTML = '';
                statusOutputArea.appendChild(gpuErrorContainer);
            } else {
                statusTextDiv.textContent = messageText;
                if (type === "success") { statusTextDiv.style.color = "var(--igadlm-alpha-color-success)"; statusTextDiv.style.fontWeight = "600";
                } else if (type === "error") { statusTextDiv.style.color = "var(--igadlm-alpha-color-error)"; statusTextDiv.style.fontWeight = "600";
                } else { statusTextDiv.style.color = "var(--igadlm-alpha-color-text-muted)"; statusTextDiv.style.fontWeight = "500"; }
            }
        }

        async function callGradioApi(baseUrl, fnIndex, dataPayload, sessionHash, triggerId = null) {
            const joinUrl = `${baseUrl}/gradio_api/queue/join`;
            const apiPayload = { data: dataPayload, event_data: null, fn_index: fnIndex, session_hash: sessionHash, };
            if (triggerId !== null) apiPayload.trigger_id = triggerId;
            const response = await fetch(joinUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(apiPayload) });
            if (!response.ok) {
                let errorData = {}; try { errorData = await response.json(); } catch(e) {}
                const errorDetail = (errorData.detail || errorData.error || `HTTP ${response.status} - ${response.statusText}`).toString();
                const errorDetailLower = errorDetail.toLowerCase();
                if (errorDetailLower.includes("cuda") || errorDetailLower.includes("gpu") || errorDetailLower.includes("quota") || errorDetailLower.includes("capacity") || errorDetailLower.includes("load")) {
                    throw { type: "gpu_quota", message: `سرور با محدودیت منابع (GPU) مواجه است: ${errorDetail.substring(0,150)}` };
                }
                throw new Error(`خطا در ارتباط اولیه: ${errorDetail.substring(0,100)}`);
            }
            const result = await response.json();
            if (!result.event_id) { throw new Error(`event_id دریافت نشد.`); }
            return result.event_id;
        }

        function listenToGradioSse(baseUrl, sessionHash, eventId, serviceName, onProgress) {
            return new Promise((resolve, reject) => {
                if (currentEventSource) { currentEventSource.close(); }
                const dataUrl = `${baseUrl}/gradio_api/queue/data?session_hash=${sessionHash}`;
                currentEventSource = new EventSource(dataUrl);
                currentEventSource.onmessage = function(event) {
                    const eventData = JSON.parse(event.data);
                    onProgress(eventData);
                    if (eventData.msg === "process_completed") {
                        currentEventSource.close();
                        if (eventData.success && eventData.output && eventData.output.data) {
                            resolve(eventData.output.data);
                        } else {
                            const errorMsg = eventData.output?.error || `خطا در تکمیل پردازش ${serviceName}.`;
                            if (errorMsg.toLowerCase().includes("gpu") || errorMsg.toLowerCase().includes("cuda")) {
                                reject({ type: "gpu_quota", message: errorMsg });
                            } else {
                                reject(new Error(`پردازش ${serviceName} با خطا مواجه شد: ${errorMsg}`));
                            }
                        }
                    } else if (eventData.msg === "queue_full") { currentEventSource.close(); reject(new Error(`صف ${serviceName} پر است.`)); }
                };
                currentEventSource.onerror = function() { currentEventSource.close(); reject(new Error(`خطا در اتصال به جریان نتایج سرور ${serviceName}.`)); };
            });
        }
        
        async function getPromptForImageGeneration(userPersianPrompt) {
            if (!userPersianPrompt.trim()) {
                updateStatus("آماده‌سازی برای ساخت تصویر تصادفی...", "info", true);
                return "";
            }
            updateStatus("در حال ترجمه متن...", "info", true);
            const sessionHash = generateSessionHash();
            const payload = [userPersianPrompt, ...TRANSLATOR_OTHER_PARAMS];
            const eventId = await callGradioApi(TRANSLATOR_API_BASE_URL, TRANSLATOR_FN_INDEX, payload, sessionHash);
            const translationResult = await listenToGradioSse(TRANSLATOR_API_BASE_URL, sessionHash, eventId, "Translator", (e) => {});
            if (translationResult && translationResult[0]) {
                return translationResult[0];
            } else { throw new Error("نتیجه معتبری از سرویس ترجمه دریافت نشد."); }
        }

        async function createImage(promptForImage, aspectRatioKey) {
            const sessionHash = generateSessionHash();
            const dimensions = PREDEFINED_DIMENSIONS_MAP[aspectRatioKey];
            const randomSeed = Math.floor(Math.random() * 2147483647);
            const imageGenPayload = [promptForImage, randomSeed, DEFAULT_RANDOMIZE_SEED, dimensions.width, dimensions.height, DEFAULT_GUIDANCE_SCALE, DEFAULT_INFERENCE_STEPS];
            
            updateStatus("ساخت تصویر (ارسال درخواست)...", "info", true);
            const eventId = await callGradioApi(IMAGE_GENERATOR_API_BASE_URL, IMAGE_GENERATOR_FN_INDEX, imageGenPayload, sessionHash, IMAGE_GENERATOR_TRIGGER_ID);
            
            return listenToGradioSse(IMAGE_GENERATOR_API_BASE_URL, sessionHash, eventId, "ImageGenerator", (eventData) => {
                if (eventData.msg === "process_generating" && eventData.output?.data?.[0]?.[0]?.[0]) {
                    const partialImageUrl = eventData.output.data[0][0][0].url;
                    // **تغییر برای پراکسی:** URL تصویر را هم از طریق پراکسی بارگذاری می‌کنیم
                    const fullUrl = partialImageUrl.startsWith("http") ? partialImageUrl : `${HF_IMAGE_GENERATOR_BASE}${partialImageUrl}`;
                    const proxiedImageUrl = `${PROXY_ENDPOINT}?target_url=${encodeURIComponent(fullUrl)}`;

                    generatedImageElem.src = proxiedImageUrl;
                    finalGeneratedImageUrlFromSpace = fullUrl; // آدرس اصلی را برای دانلود نگه می‌داریم

                    if (imageResultContainer.style.display === 'none') {
                        imageResultContainer.style.display = 'block';
                        generatedImageElem.style.display = 'block';
                        updateStatus("در حال ساخت تصویر با هوش مصنوعی آلفا", "info", true);
                    }
                }
            }).then(imageResult => {
                 let finalUrl = imageResult?.[0]?.[0]?.[0]?.url;
                 if (finalUrl) {
                     return finalUrl.startsWith("http") ? finalUrl : `${HF_IMAGE_GENERATOR_BASE}${finalUrl}`;
                 }
                 throw new Error("URL تصویر نهایی یافت نشد.");
            });
        }

        // **تغییر:** تابع دانلود ساده‌تر شده و از آپلود مجدد استفاده نمی‌کند
        async function downloadImageDirectly(imageUrl) {
            if (!imageUrl) {
                downloadLinkStatusEl.textContent = "خطا: URL تصویر برای دانلود موجود نیست.";
                return;
            }
            downloadLinkStatusEl.textContent = 'در حال آماده‌سازی دانلود...';
            downloadImageBtn.disabled = true;

            try {
                // تصویر از طریق پراکسی فچ می‌شود تا فیلترینگ را دور بزند
                const proxiedUrl = `${PROXY_ENDPOINT}?target_url=${encodeURIComponent(imageUrl)}`;
                const response = await fetch(proxiedUrl);
                if (!response.ok) throw new Error(`خطا در دریافت فایل: ${response.statusText}`);
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `generated_image_${Date.now()}.webp`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                
                downloadLinkStatusEl.textContent = 'دانلود شروع شد!';
            } catch (error) {
                console.error("خطا در دانلود تصویر:", error);
                downloadLinkStatusEl.textContent = `خطا: ${error.message}`;
            } finally {
                downloadImageBtn.disabled = false;
            }
        }

        downloadImageBtn.addEventListener('click', () => {
            downloadImageDirectly(finalGeneratedImageUrlFromSpace);
        });

        async function startFullProcess(isRetry = false) {
            if (!isRetry) {
                lastAttemptedPayload = { persianPrompt: imagePromptInput.value, aspectRatioKey: selectedAspectRatioKey };
            }
            generateBtn.disabled = true;
            showMainForm();
            updateStatus("در حال آماده سازی...", "info", true);

            try {
                const onRetryCallback = (attempt, max) => updateStatus(`ارتباط برقرار نشد. تلاش مجدد (${attempt}/${max})...`, "info", true);
                
                const finalPrompt = await retryableOperation(() => getPromptForImageGeneration(lastAttemptedPayload.persianPrompt), 3, 2500, onRetryCallback);
                const imageUrl = await retryableOperation(() => createImage(finalPrompt, lastAttemptedPayload.aspectRatioKey), 3, 2500, onRetryCallback);

                finalGeneratedImageUrlFromSpace = imageUrl;
                updateStatus("تصویر با موفقیت ساخته شد.", "success", false);

            } catch (error) {
                console.error("خطا در فرآیند کلی:", error);
                updateStatus(error, "error", false);
            } finally {
                generateBtn.disabled = false;
                if (aiLoader.style.display === 'flex' && !statusTextDiv.textContent.includes("موفقیت")) {
                    aiLoader.style.display = 'none';
                }
            }
        }

        generateBtn.addEventListener('click', () => startFullProcess(false));
        populateDimensionButtons();
        showMainForm();
        updateStatus("وضعیت: آماده برای تولید تصویر.", "info", false);
    })();
</script>
</body>
</html>
